---
title: "Data Visualistation Story Telling"
author: "Vincent Krieg"
date: "11/14/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Republicans don't believe in climate change so those states will use less renewable Energies

It is common knowledge that part of the Republican Party in the United States denies the existence
of man made climate change. Since they do not believe in man made climat change, one could expect 
that the amount of renewable energies in those states that have voted for the Republicans in the 2020
Presidential Election, the percentage of renewable energies in the energy mix is rather low. In contrast
if the percentage of votes for the Republican Party in 2020 has no effect what factors play a more 
important role for the percentage of renewable energy in a states energy mix?

```{r}
library(readr)
library(tidyverse)
library(usmap)
library(ggplot2)
library(yhat)
library(gridExtra)
library(grid)
```

### Import of the Data ###

```{r}
totalData <- read_csv("totalData.csv")
```
The first plot is supposed to give an overview over the political outcome and the energy mix of a state side by side.
In order to achiev this the political results are used to display who of the two parties has gained more votes in a state
and the state will then be marked according to the winning political parties color. in the graph on the right the percentage
of renewable energy in the energy mix of a state will be represented. In order to achieve this the data on the was filtered
for the year 2020 and to only show the total amount of electricity used in a state cummulated over all segments. After this the cummulated sum over the renewable energies was build and divided by the total amount of energy consumed in a state.
```{r}
mapDemRep <- totalData %>% filter(YEAR=="2020") %>% filter(Type_of_Producer=='Total Electric Power Industry') %>% mutate(dem_rep=if_else(dem_percent>rep_percent,"Democratic","Republican"))
cols <- c("Republican" = "red", "Democratic" = "blue")
USplot <-  plot_usmap(data = mapDemRep, values="dem_rep",regions = "states",labels = TRUE) + 
 scale_fill_manual(values = cols, name = "Political Party which \nwon the state", 
                  guide = guide_legend(reverse = TRUE))+
    labs(title = "Pesidential elections in the US 2020") +
  theme(legend.position = "bottom")
  
USplot$layers[[2]]$aes_params$size <- 2



```
```{r}
greenCard <- totalData %>% filter(YEAR=="2020") %>% filter(Type_of_Producer=='Total Electric Power Industry')  %>% mutate(renewableTotal=HydroElectric+Wind+wood+biomass+Geothermal+Solar) %>% mutate(renewablePercent= (renewableTotal/Total)*100)

USplot1 <-  plot_usmap(data =greenCard, values="renewablePercent",regions = "states",labels = TRUE) + 
    scale_fill_continuous(low = "white", high = "darkgreen", name = "Renewable Energy in %", label = scales::comma)+
    labs(
       title = "Percentage of renewable energy used by state 2020") +
  theme(legend.position = "bottom")
  
USplot1$layers[[2]]$aes_params$size <- 2


grid.arrange(USplot,USplot1, ncol=2, top=textGrob("Politics and renewable energies in the United States",gp=gpar(fontsize=20,font=3)))


```
```{r}
```
When looking at the first graph and with the questions from the begining there are some interesting observations can be made.

1. The States with the highest amount of renewables are in the northern part of the united states
2. Idaho and South Dakota were won by the republicans but have a high percentage of renewables 
3. There is a large range of percentages of renewables between the individual states
4. There is no obvious correlation between the percentage of renewables and the party that won a state
  

```{r}
greenCard <- greenCard %>% 
  mutate(coalPercent= (Coal/Total)*100) %>%
  mutate(HydroElectricPercent= (HydroElectric/Total)*100) %>%
  mutate(gasPercent= (Gas/Total)*100) %>%
  mutate(petroleumPercent= (Petroleum/Total)*100) %>%
  mutate(windPercent= (Wind/Total)*100) %>%
  mutate(woodPercent= (wood/Total)*100) %>%
  mutate(nuclearPercent= (Nuclear/Total)*100) %>%
  mutate(biomassPercent= (biomass/Total)*100) %>%
  mutate(geothermalPercent= (Geothermal/Total)*100) %>%
  mutate(solarPercent= (Solar/Total)*100)


```

On the basis of the first plot it would be interesting to see which renewable energy production type is used by which state.
In order to get this inforamtion the processed data from part one is used and for each state the percentage of all the different power sources is calculated. Additionally a function is used to make the construction of the repeating graphs 
easier.
All plots are generated so that with adjusting the code a little bit all the other energy sources could be easily displayed.



```{r}

createUSmap <- function(colName,colorPlot, nameScale, titlePlot){
  returnPlot <-  plot_usmap(data =greenCard, values=colName,regions = "states") + 
    scale_fill_continuous(low = "white", high = colorPlot, 
                          name = nameScale, label = scales::comma)+
    labs(title = titlePlot)+
  theme(legend.position = "right",
        legend.key.height = unit(3, 'mm'), 
        legend.key.width = unit(1, 'mm'),
        legend.title =element_text(size=8),
        plot.title = element_text(hjust = 0.5))
  returnPlot$layers[[2]]$aes_params$size <- 2
  return(returnPlot)
}

  

coal <- createUSmap("coalPercent","black","% of total \nenergymix \nby state", "Coal")
hydro <- createUSmap("HydroElectricPercent","darkblue","% of total \nenergymix \nby state", "Hydro Electic")
gas <- createUSmap("gasPercent","brown","% of total \nenergymix \nby state", "Natural Gas")
petr <- createUSmap("petroleumPercent","wheat4","% of total \nenergymix \nby state", "Petroleum")
wind <- createUSmap("windPercent","lightblue","% of total \nenergymix \nby state", "Wind")
nuc <- createUSmap("nuclearPercent","green","% of total \nenergymix \nby state", "Nuclear")
bio <- createUSmap("biomassPercent","darkgreen","% of total \nenergymix \nby state", "Biomass")
geo <- createUSmap("geothermalPercent","darkred","% of total \nenergymix \nby state", "Geothermal")
solar <- createUSmap("solarPercent","yellow","% of total \nenergymix \nby state", "Solar")
wood <- createUSmap("woodPercent","saddlebrown","% of total \nenergymix \nby state", "Wood")

```

After looking through all different sources the 4, in my opinion, most interesting ones were picked and displayed below.
By combining those 4 into one grafic.

## Analysis of the individual parts of the energymix in the 52 states

The darker the color the higher the percentage of the energymix of this state.
Be aware of the color scheme as they differ between the productiontypes. This 
is on purpose to to better show the variety if the maximum percentage is rather low.

```{r}
grid.arrange(solar,wood,geo,wind, ncol=2,nrow=2, top=textGrob(expression(bold(underline("Renewable Energies"))),gp=gpar(fontsize=20,font=3)))


```
```{r}
```



__Interessting aspects__ <br />
Solar
  
* Mainly used in california and nevada
* Texas is relativly low eventhough the state has favorable wetherconditions for this type of energy production
    
Wood
  
* Main and Vermont booth get more than 15 % of their energy from wood
* Georga and New Hemsphire get a little over 4 % of their energy supplied by wood
    
Geothermal
  
* Hardly adds to the supply of Energy throught the US 
* The hotspot for this technology is Nevada 
* Followed by California
    
Wind
  
* Relative percentage of wind as a source of power is greate in the center of the country 
* Wind does not account for much of the energysupply on the coast 
    
    


```{r}


#Check for the logarithmic functions used in the Regression
greenCard <- greenCard[!(greenCard$state == "US-Total"),]
greenCard <- greenCard[!(greenCard$state == "DC"),]

greenCard <- greenCard %>% mutate(renewablePercent = log(renewablePercent)) %>% mutate(PopulationInMio = Population/1000000) %>% mutate(GdpinBUSD = GdpinMioUSD/1000)

CorrelationPlots <- pivot_longer(greenCard,cols = c("SunHours", "AvgWindSpeed", "PopulationInMio", "EducationIndex", "rep_percent", "GdpinBUSD"), names_to = "VarName", values_to = "VarValues")
```


```{r}
p <- ggplot(CorrelationPlots, mapping = aes(VarValues, renewablePercent)) + 
  geom_point(size=0.75)+
  geom_smooth(method='lm')
p + facet_wrap(~VarName, scales = "free", ncol = 3, labeller = labeller(VarName =
                                                                            c("SunHours" = "Average sunshine hours per day", 
                                                                              "AvgWindSpeed" = "Average Wind Speed in mph", 
                                                                              "PopulationInMio"= "Population in mio", 
                                                                              "EducationIndex"="Education index", 
                                                                              "rep_percent" = "Percentage votes Republicans 2020 ",
                                                                              "GdpinBUSD" = "GDP in billion USD in 2020")
                                                                          ))+
  ylab("Log percentage of renewable energy")+
  xlab("")+
  labs(title = "Correlation of individual factors on the percentage of renewable energy used" )+
  theme(panel.spacing = unit(1, "lines"),
        strip.text=element_text(size=8))

```
```{r}
```
Form the grafic one can  tell that GDP and Population themself make not much sense to use in the regression. THey appear to have a similar distribution. In addition to this is the consideration that population and GDP are correlated and violate the Markov Theorem for multicolinarity.
Therefor it makes sense to GDP per Capita in Million which can be achieved by dividing the GDP by the population of a state.
When combining the two fators they became irrelevant for the regression.

```{r}
greenCard <- greenCard %>% mutate(gdpPerCap = GdpinMioUSD/Population)
lmodel <- lm(renewablePercent ~ SunHours + AvgWindSpeed + gdpPerCap + EducationIndex +  rep_percent, data = greenCard)
summary(lmodel)

```
After the adjustments only the average windspeed and the average sun hours appear to be factors for the amount of renewables that are being used in a state.
Notes to the regression:
  * only explains 19.24 % of the variations in the data
  * other relevant factors have been left out (e.g. factor that would help describe the percentage of hydro)
  * the regression still explains part of the issue as the p-value for the test that all ß=0 is smaller than .05
  


```{r}
greenCard <- data.frame(greenCard, y_hat = fitted(lmodel), e = residuals(lmodel))
```
## Error analyse 

When looking at the plot bellow which shows the fitted y vs the actual y, one can tell that the regression is not \n
really good. It is obvious that the predicted value is overestimated in the first half and underestimated in the \n
second half. This translates to low actual y's being overestimated and high actual y's being underestimated. \n
The redline represents where the prediction would perfectly match the actual y value.


```{r}
greenCard %>% ggplot(mapping = aes(renewablePercent, y_hat))+
  geom_point(color = "steelblue")+
  geom_line(data = greenCard,mapping= aes(renewablePercent, renewablePercent), color = "darkred")+
  ylab("Predicted log renewable energy percent")+
  xlab("Actual log renewable energy percent")+
  labs(title = "Error analysis")+
  theme_bw()

```

```{r}
barPlotData <- totalData %>% 
  mutate(coalPercent= (Coal/Total)*100) %>%
  mutate(HydroElectricPercent= (HydroElectric/Total)*100) %>%
  mutate(gasPercent= (Gas/Total)*100) %>%
  mutate(petroleumPercent= (Petroleum/Total)*100) %>%
  mutate(windPercent= (Wind/Total)*100) %>%
  mutate(woodPercent= (wood/Total)*100) %>%
  mutate(nuclearPercent= (Nuclear/Total)*100) %>%
  mutate(biomassPercent= (biomass/Total)*100) %>%
  mutate(geothermalPercent= (Geothermal/Total)*100) %>%
  mutate(solarPercent= (Solar/Total)*100) %>% filter(YEAR == 2020) %>% filter(state == "US-Total") %>% filter(Type_of_Producer =="Total Electric Power Industry")
barPlotData <- pivot_longer(barPlotData,cols = c("coalPercent", "HydroElectricPercent", "gasPercent", "petroleumPercent", "windPercent","woodPercent", "nuclearPercent","biomassPercent","geothermalPercent","solarPercent"), names_to = "VarName", values_to = "VarValues")
barPlotData <- barPlotData[order(-barPlotData$VarValues),]

```



```{r}
barPlotData %>% ggplot(mapping = aes(fct_reorder(VarName,
                         VarValues, .desc = TRUE), 
             VarValues)) +
  geom_col(aes(fill = fct_reorder(VarName, VarValues, .desc = TRUE)))+
  
  ylab("Percentage in the US energymix")+
  scale_fill_manual(values=c("gasPercent"="burlywood4","nuclearPercent"="green","coalPercent"="black",
                             "windPercent"="lightblue","HydroElectricPercent"="darkblue","solarPercent"="yellow",
                             "biomassPercent"="darkgreen","petroleumPercent"="grey","geothermalPercent"="darkred",
                             "woodPercent"="saddlebrown"), 
                       name="Energy Source",
                       labels=c("Gas","Nuclear", "Coal", "Wind", "Hydro", "Solar", "Biomass","Petroleum", "Geothermal",
                                "Wood"))+
  labs(title = "Energymix in the United States")+
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        legend.position="right",
        plot.title = element_text(hjust = 0.5))
  

```
```{r}


```




